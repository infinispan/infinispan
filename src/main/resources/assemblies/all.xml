<?xml version="1.0" encoding="UTF-8"?>

<!--
   This package will build a ZIP containing the following:

   + modules
      + core
         - infinispan-core.jar
         + lib (contains dependencies)
      + tree
         - infinispan-tree.jar
         + lib (excluding core)

      .. etc ...

   + test
      + modules
         ... as above, for test jars and deps ...

   + bin (any scripts, etc)
   + etc (sample configs, resources, etc from src/main/resources)
   + doc (release notes, etc from src/main/release)
-->
<assembly
      xmlns="http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.0"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.0 http://maven.apache.org/xsd/assembly-1.1.0.xsd">
   <id>all</id>

   <formats>
      <format>zip</format>
   </formats>

   <moduleSets>

      <moduleSet>
         <includeSubModules>false</includeSubModules>
         <includes>
            <include>org.infinispan:infinispan-core</include>
         </includes>
         <sources>
            <includeModuleDirectory>false</includeModuleDirectory>
            <outputDirectory>src</outputDirectory>

            <fileSets>

               <!-- resources -->
               <fileSet>
                  <directory>src/main/resources</directory>
                  <outputDirectory>etc</outputDirectory>
                  <excludes>
                     <exclude>**/*.sh</exclude>
                     <exclude>**/*.bat</exclude>
                     <exclude>**/*.cmd</exclude>
                     <exclude>**/*.py</exclude>
                  </excludes>
               </fileSet>

               <!-- Executable resources -->
               <fileSet>
                  <directory>src/main/resources</directory>
                  <outputDirectory>bin</outputDirectory>
                  <includes>
                     <include>**/*.sh</include>
                     <include>**/*.bat</include>
                     <include>**/*.cmd</include>
                     <include>**/*.py</include>
                  </includes>
                  <fileMode>0777</fileMode>
               </fileSet>

               <!-- Log4j XML -->
               <fileSet>
                  <directory>src/test/resources</directory>
                  <outputDirectory>etc</outputDirectory>
                  <includes>
                     <include>log4j.xml</include>
                  </includes>
               </fileSet>

               <!-- EULAs and license files -->
               <fileSet>
                  <directory>src/main/release</directory>
                  <outputDirectory></outputDirectory>
                  <includes>
                     <include>**/*.txt</include>
                  </includes>
               </fileSet>

            </fileSets>

         </sources>

         <binaries>

            <outputDirectory>.</outputDirectory>
            <outputFileNameMapping>
               ${module.artifactId}.${module.extension}
            </outputFileNameMapping>
            <unpack>false</unpack>

            <dependencySets>
               <dependencySet>
                  <excludes>
                     <exclude>org.rhq.helpers:rhq-pluginAnnotations</exclude>
                  </excludes>
                  <useTransitiveDependencies>false</useTransitiveDependencies>
                  <outputDirectory>./lib</outputDirectory>
               </dependencySet>
            </dependencySets>

         </binaries>
      </moduleSet>

      <moduleSet>
         <includeSubModules>false</includeSubModules>
         <includes>
            <include>org.infinispan:infinispan-cachestore-bdbje</include>
            <include>org.infinispan:infinispan-cachestore-jdbc</include>
            <include>org.infinispan:infinispan-cachestore-jdbm</include>
            <include>org.infinispan:infinispan-cachestore-s3</include>
            <include>org.infinispan:infinispan-gui-demo</include>
            <include>org.infinispan:infinispan-ec2-demo</include>
            <include>org.infinispan:infinispan-jopr-plugin</include>
            <include>org.infinispan:infinispan-tree</include>
            <include>org.infinispan:infinispan-query</include>
            <include>org.infinispan:infinispan-server-rest</include>
            <include>org.infinispan:infinispan-lucene-directory</include>
            <include>org.infinispan:infinispan-lucene-demo</include>
         </includes>
         <sources>
            <includeModuleDirectory>false</includeModuleDirectory>
            <outputDirectory>src</outputDirectory>

            <fileSets>

               <!-- resources -->
               <fileSet>
                  <directory>src/main/resources</directory>
                  <outputDirectory>etc</outputDirectory>
                  <excludes>
                     <exclude>**/*.sh</exclude>
                     <exclude>**/*.bat</exclude>
                     <exclude>**/*.cmd</exclude>
                     <exclude>**/*.py</exclude>
                  </excludes>
               </fileSet>

               <!-- schema (generated!) -->
               <fileSet>
                  <directory>target/classes</directory>
                  <outputDirectory>etc</outputDirectory>
                  <includes>
                     <include>**/*.xsd</include>
                  </includes>
               </fileSet>

               <!-- Executable resources -->
               <fileSet>
                  <directory>src/main/resources</directory>
                  <outputDirectory>bin</outputDirectory>
                  <includes>
                     <include>**/*.sh</include>
                     <include>**/*.bat</include>
                     <include>**/*.cmd</include>
                     <include>**/*.py</include>
                  </includes>
                  <fileMode>0777</fileMode>
               </fileSet>

               <!-- Log4j XML -->
               <fileSet>
                  <directory>src/test/resources</directory>
                  <outputDirectory>etc</outputDirectory>
                  <includes>
                     <include>log4j.xml</include>
                  </includes>
               </fileSet>

               <!-- EULAs and license files -->
               <fileSet>
                  <directory>src/main/release</directory>
                  <outputDirectory></outputDirectory>
                  <includes>
                     <include>**/*.txt</include>
                  </includes>
               </fileSet>

            </fileSets>

         </sources>

         <!-- All modules except core and Webapp modules -->
         <binaries>

            <outputDirectory>modules/${module.basedir.name}</outputDirectory>
            <outputFileNameMapping>
               ${module.artifactId}.${module.extension}
            </outputFileNameMapping>
            <unpack>false</unpack>

            <dependencySets>
               <dependencySet>
                  <excludes>
                     <exclude>infinispan-core*</exclude>
                     <exclude>net.jcip:jcip-annotations</exclude>
                     <exclude>org.rhq.helpers:rhq-pluginAnnotations</exclude>
                     <exclude>org.infinispan:infinispan-core</exclude>
                     <exclude>org.infinispan:infinispan-server-rest</exclude>
                     <exclude>org.infinispan:infinispan-ec2-demo</exclude>                     
                  </excludes>
                  <useTransitiveDependencies>true</useTransitiveDependencies>
                  <useTransitiveFiltering>true</useTransitiveFiltering>
                  <outputDirectory>modules/${module.basedir.name}/lib</outputDirectory>
               </dependencySet>
            </dependencySets>

         </binaries>
      </moduleSet>

      <!-- Tests for all modules except REST server and EC2 demo which are webapps -->
      <moduleSet>
         <includeSubModules>false</includeSubModules>
         <includes>
            <include>org.infinispan:infinispan-cachestore-bdbje</include>
            <include>org.infinispan:infinispan-cachestore-jdbc</include>
            <include>org.infinispan:infinispan-cachestore-jdbm</include>
            <include>org.infinispan:infinispan-cachestore-s3</include>
            <include>org.infinispan:infinispan-gui-demo</include>
            <include>org.infinispan:infinispan-jopr-plugin</include>
            <include>org.infinispan:infinispan-tree</include>
            <include>org.infinispan:infinispan-query</include>
            <include>org.infinispan:infinispan-lucene-directory</include>
            <include>org.infinispan:infinispan-lucene-demo</include>            
         </includes>         
         <binaries>
            <attachmentClassifier>tests</attachmentClassifier>
            <outputDirectory>test/modules/${module.basedir.name}</outputDirectory>
            <outputFileNameMapping>
               ${module.artifactId}-test.${module.extension}
            </outputFileNameMapping>
            <unpack>false</unpack>

            <dependencySets>
               <dependencySet>
                  <scope>test</scope>
                  <excludes>
                     <exclude>infinispan-core*</exclude>
                  </excludes>
                  <useTransitiveDependencies>false</useTransitiveDependencies>
                  <outputDirectory>test/modules/${module.basedir.name}/lib</outputDirectory>
               </dependencySet>
            </dependencySets>

         </binaries>
      </moduleSet>

      <!-- REST server and ec2-demo module which are webapps -->
      <moduleSet>
         <includeSubModules>false</includeSubModules>
         <includes>
            <include>org.infinispan:infinispan-server-rest</include>
            <include>org.infinispan:infinispan-ec2-demo</include>
         </includes>
         <sources>
            <includeModuleDirectory>false</includeModuleDirectory>
            <outputDirectory>src</outputDirectory>
         </sources>

         <binaries>
            <outputDirectory>modules/${module.basedir.name}</outputDirectory>
            <outputFileNameMapping>
               ${module.artifactId}.${module.extension}
            </outputFileNameMapping>
            <unpack>false</unpack>
            <dependencySets>
               <dependencySet>
                  <includes>
                     <include>NONEXISTENT_DEPENDENCY*</include>
                  </includes>
                  <outputDirectory>modules/${module.basedir.name}</outputDirectory>
               </dependencySet>
            </dependencySets>
         </binaries>
      </moduleSet>
   </moduleSets>

   <fileSets>

      <!-- docs -->
      <fileSet>
         <directory>target/site/apidocs</directory>
         <outputDirectory>doc/apidocs</outputDirectory>
      </fileSet>

   </fileSets>

</assembly>
