<?xml version="1.0" encoding="UTF-8"?>
<!--
   This package will build a ZIP containing the following:

   - infinispan-core.jar
   + lib (contains dependencies for core)
   + modules
      + tree
         - infinispan-tree.jar
         + lib (dependencies for tree, excluding core)

      .. etc ...

   + test
      + modules
         ... as above, for test jars and deps ...

   + bin (any scripts, etc)
   + etc (sample configs, resources, etc from src/main/resources)
   + doc (release notes, etc from src/main/release)
-->
<assembly
      xmlns="http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.2"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.2 http://maven.apache.org/xsd/assembly-1.1.2.xsd">
   <id>all</id>

   <baseDirectory>${project.artifactId}-${project.version}-all</baseDirectory>

   <formats>
      <format>zip</format>
   </formats>

   <moduleSets>

      <!--
         Gather all transitive runtime dependencies and place them in lib dir of the zip package (runtime-classpath.txt of each module will reference them from here).
         This is done in a single moduleSet instead of the 'binaries' section of each module in order to avoid the issue with possibly skipped dependencies or
         incorrectly resolved versions that is already described in the assembly plugin user guide in relation with multiple moduleSets. This issue appeared in
         version 2.2 of the plugin and is a documented limitation of the moduleSets mechanism (which might become deprecated in the future). The user guide
         recommends avoiding moduleSets altogether in favor of dependencySets but that solution does not work in our case because we would not be able to include
         other files in the distribution (scripts, config files, demo data files, etc). That means we'll continue to live (dangerously) with moduleSets.
      -->
      <moduleSet>
         <includeSubModules>false</includeSubModules>
         <includes>
            <include>org.infinispan:infinispan-core</include>
            <include>org.infinispan:infinispan-rhq-plugin</include>
            <include>org.infinispan:infinispan-tree</include>
            <include>org.infinispan:infinispan-query</include>
            <include>org.infinispan:infinispan-server-memcached</include>
            <include>org.infinispan:infinispan-server-hotrod</include>
            <include>org.infinispan:infinispan-server-websocket</include>
            <include>org.infinispan:infinispan-client-hotrod</include>
            <include>org.infinispan:infinispan-lucene-directory</include>
            <include>org.infinispan:infinispan-spring</include>
            <include>org.infinispan:infinispan-cli-client</include>
            <include>org.infinispan:infinispan-cli-server</include>
            <include>org.infinispan:infinispan-cachestore-jdbc</include>
            <include>org.infinispan:infinispan-cachestore-jpa</include>
            <include>org.infinispan:infinispan-cachestore-remote</include>
            <include>org.infinispan:infinispan-cachestore-cli</include>
            <include>org.infinispan:infinispan-cachestore-rest</include>
            <include>org.infinispan:infinispan-cachestore-leveldb</include>
            <include>org.infinispan:infinispan-gui-demo</include>
            <include>org.infinispan:infinispan-ec2-demo</include>
            <include>org.infinispan:infinispan-distexec-demo</include>
            <include>org.infinispan:infinispan-directory-demo</include>
            <include>org.infinispan:infinispan-nearcache-demo</include>
            <include>org.infinispan:infinispan-lucene-demo</include>
            <include>org.infinispan:infinispan-cdi</include>
         </includes>

         <binaries>
            <unpack>false</unpack>
            <outputDirectory>lib</outputDirectory>
            <dependencySets>
               <dependencySet>
                  <useStrictFiltering>true</useStrictFiltering>
                  <useTransitiveDependencies>true</useTransitiveDependencies>
                  <useTransitiveFiltering>true</useTransitiveFiltering>
                  <outputDirectory>lib</outputDirectory>
               </dependencySet>
            </dependencySets>
         </binaries>
      </moduleSet>

      <!-- Core module -->
      <moduleSet>
         <includeSubModules>false</includeSubModules>
         <includes>
            <include>org.infinispan:infinispan-core</include>
         </includes>
         <sources>
            <includeModuleDirectory>false</includeModuleDirectory>

            <fileSets>
               <!-- Executable resources -->
               <fileSet>
                  <directory>src/main/release</directory>
                  <outputDirectory></outputDirectory>
                  <lineEnding>unix</lineEnding>
                  <includes>
                     <include>**/*.sh</include>
                     <include>**/*.py</include>
                     <include>**/*.rb</include>
                  </includes>
                  <fileMode>0755</fileMode>
               </fileSet>

               <fileSet>
                  <directory>src/main/release</directory>
                  <outputDirectory></outputDirectory>
                  <lineEnding>dos</lineEnding>
                  <includes>
                     <include>**/*.cmd</include>
                     <include>**/*.bat</include>
                  </includes>
                  <fileMode>0644</fileMode>
               </fileSet>

               <!-- Configuration resources -->
               <fileSet>
                  <directory>src/main/release</directory>
                  <outputDirectory></outputDirectory>
                  <lineEnding>unix</lineEnding>
                  <includes>
                     <include>**/*.properties</include>
                     <include>**/*.xml</include>
                     <include>**/*.xsd</include>
                     <include>**/*.html</include>
                     <include>**/*.js</include>
                     <include>**/*.css</include>
                  </includes>
               </fileSet>

               <!-- Binary resources -->
               <fileSet>
                  <directory>src/main/release</directory>
                  <outputDirectory></outputDirectory>
                  <lineEnding>keep</lineEnding>
                  <includes>
                     <include>**/*.gz</include>
                  </includes>
               </fileSet>

               <!-- Schema -->
               <fileSet>
                  <directory>target/classes</directory>
                  <outputDirectory>etc</outputDirectory>
                  <lineEnding>unix</lineEnding>
                  <includes>
                     <include>**/*.xsd</include>
                  </includes>
               </fileSet>

               <!-- Log4j XML -->
               <fileSet>
                  <directory>src/test/resources</directory>
                  <outputDirectory>etc</outputDirectory>
                  <lineEnding>unix</lineEnding>
                  <includes>
                     <include>log4j.xml</include>
                  </includes>
               </fileSet>

               <!-- EULAs and license files -->
               <fileSet>
                  <directory>src/main/release</directory>
                  <outputDirectory></outputDirectory>
                  <lineEnding>dos</lineEnding>
                  <includes>
                     <include>**/*.txt</include>
                  </includes>
               </fileSet>

               <!-- runtime-classpath.txt file -->
               <fileSet>
                  <directory>target</directory>
                  <outputDirectory></outputDirectory>
                  <lineEnding>keep</lineEnding>
                  <includes>
                     <include>runtime-classpath.txt</include>
                  </includes>
               </fileSet>
            </fileSets>

         </sources>

         <binaries>
            <outputFileNameMapping>
               ${module.artifactId}.${module.extension}
            </outputFileNameMapping>
            <unpack>false</unpack>
         </binaries>
      </moduleSet>

      <!-- Rest of modules except demos, rest server and cache stores -->
      <moduleSet>
         <includeSubModules>false</includeSubModules>
         <includes>
            <include>org.infinispan:infinispan-rhq-plugin</include>
            <include>org.infinispan:infinispan-tree</include>
            <include>org.infinispan:infinispan-query</include>
            <include>org.infinispan:infinispan-client-hotrod</include>
            <include>org.infinispan:infinispan-lucene-directory</include>
            <include>org.infinispan:infinispan-spring</include>
            <include>org.infinispan:infinispan-cli-client</include>
            <include>org.infinispan:infinispan-cli-server</include>
         </includes>
         <sources>
            <includeModuleDirectory>false</includeModuleDirectory>

            <fileSets>
               <!-- Executable resources -->
               <fileSet>
                  <directory>src/main/release</directory>
                  <outputDirectory></outputDirectory>
                  <lineEnding>unix</lineEnding>
                  <includes>
                     <include>**/*.sh</include>
                     <include>**/*.py</include>
                     <include>**/*.rb</include>
                  </includes>
                  <fileMode>0755</fileMode>
               </fileSet>

               <fileSet>
                  <directory>src/main/release</directory>
                  <outputDirectory></outputDirectory>
                  <lineEnding>dos</lineEnding>
                  <includes>
                     <include>**/*.cmd</include>
                     <include>**/*.bat</include>
                  </includes>
                  <fileMode>0644</fileMode>
               </fileSet>

               <!-- Configuration resources -->
               <fileSet>
                  <directory>src/main/release</directory>
                  <outputDirectory></outputDirectory>
                  <lineEnding>unix</lineEnding>
                  <includes>
                     <include>**/*.properties</include>
                     <include>**/*.xml</include>
                     <include>**/*.xsd</include>
                     <include>**/*.html</include>
                     <include>**/*.js</include>
                     <include>**/*.css</include>
                  </includes>
               </fileSet>

               <!-- Binary resources -->
               <fileSet>
                  <directory>src/main/release</directory>
                  <outputDirectory></outputDirectory>
                  <lineEnding>keep</lineEnding>
                  <includes>
                     <include>**/*.gz</include>
                  </includes>
               </fileSet>

               <!-- Schema -->
               <fileSet>
                  <directory>target/classes</directory>
                  <outputDirectory>etc</outputDirectory>
                  <lineEnding>unix</lineEnding>
                  <includes>
                     <include>**/*.xsd</include>
                  </includes>
               </fileSet>

               <!-- EULAs and license files -->
               <fileSet>
                  <directory>src/main/release</directory>
                  <outputDirectory></outputDirectory>
                  <lineEnding>dos</lineEnding>
                  <includes>
                     <include>**/*.txt</include>
                  </includes>
               </fileSet>

               <!-- runtime-classpath.txt file -->
               <fileSet>
                  <directory>target</directory>
                  <outputDirectory>modules/${module.basedir.name}</outputDirectory>
                  <lineEnding>keep</lineEnding>
                  <includes>
                     <include>runtime-classpath.txt</include>
                  </includes>
               </fileSet>
            </fileSets>

         </sources>

         <binaries>
            <outputDirectory>modules/${module.basedir.name}</outputDirectory>
            <outputFileNameMapping>
               ${module.artifactId}.${module.extension}
            </outputFileNameMapping>
            <unpack>false</unpack>
         </binaries>
      </moduleSet>

      <!-- Cache stores only! -->
      <moduleSet>
         <includeSubModules>false</includeSubModules>
         <includes>
            <include>org.infinispan:infinispan-cachestore-jdbc</include>
            <include>org.infinispan:infinispan-cachestore-jpa</include>
            <include>org.infinispan:infinispan-cachestore-remote</include>
            <include>org.infinispan:infinispan-cachestore-cli</include>
            <include>org.infinispan:infinispan-cachestore-leveldb</include>
            <include>org.infinispan:infinispan-cachestore-remote</include>
         </includes>
         <sources>
            <includeModuleDirectory>false</includeModuleDirectory>

            <fileSets>
               <!-- Executable resources -->
               <fileSet>
                  <directory>src/main/release</directory>
                  <outputDirectory></outputDirectory>
                  <lineEnding>unix</lineEnding>
                  <includes>
                     <include>**/*.sh</include>
                     <include>**/*.py</include>
                     <include>**/*.rb</include>
                  </includes>
                  <fileMode>0755</fileMode>
               </fileSet>

               <fileSet>
                  <directory>src/main/release</directory>
                  <outputDirectory></outputDirectory>
                  <lineEnding>dos</lineEnding>
                  <includes>
                     <include>**/*.cmd</include>
                     <include>**/*.bat</include>
                  </includes>
                  <fileMode>0644</fileMode>
               </fileSet>

               <!-- Configuration resources -->
               <fileSet>
                  <directory>src/main/release</directory>
                  <outputDirectory></outputDirectory>
                  <lineEnding>unix</lineEnding>
                  <includes>
                     <include>**/*.properties</include>
                     <include>**/*.xml</include>
                     <include>**/*.xsd</include>
                     <include>**/*.html</include>
                     <include>**/*.js</include>
                     <include>**/*.css</include>
                  </includes>
               </fileSet>

               <!-- Binary resources -->
               <fileSet>
                  <directory>src/main/release</directory>
                  <outputDirectory></outputDirectory>
                  <lineEnding>keep</lineEnding>
                  <includes>
                     <include>**/*.gz</include>
                  </includes>
               </fileSet>

               <!-- Schema -->
               <fileSet>
                  <directory>target/classes</directory>
                  <outputDirectory>etc</outputDirectory>
                  <lineEnding>unix</lineEnding>
                  <includes>
                     <include>**/*.xsd</include>
                  </includes>
               </fileSet>

               <!-- EULAs and license files -->
               <fileSet>
                  <directory>src/main/release</directory>
                  <outputDirectory></outputDirectory>
                  <lineEnding>dos</lineEnding>
                  <includes>
                     <include>**/*.txt</include>
                  </includes>
               </fileSet>

               <!-- runtime-classpath.txt file -->
               <fileSet>
                  <directory>target</directory>
                  <outputDirectory>modules/cachestores/${module.basedir.name}</outputDirectory>
                  <lineEnding>keep</lineEnding>
                  <includes>
                     <include>runtime-classpath.txt</include>
                  </includes>
               </fileSet>
            </fileSets>

         </sources>

         <binaries>
            <outputDirectory>modules/cachestores/${module.basedir.name}</outputDirectory>
            <outputFileNameMapping>
               ${module.artifactId}.${module.extension}
            </outputFileNameMapping>
            <unpack>false</unpack>
         </binaries>
      </moduleSet>

      <!-- Demo war apps -->
      <moduleSet>
         <includeSubModules>false</includeSubModules>
         <includes>
            <include>org.infinispan:infinispan-gridfs-webdav</include>
            <include>org.infinispan:infinispan-ec2-demoui</include>
            <include>org.infinispan:infinispan-nearcache-client</include>
         </includes>

         <sources>
            <includeModuleDirectory>false</includeModuleDirectory>
            <fileSets>
               <fileSet>
                  <directory>target</directory>
                  <outputDirectory>modules/${module.basedir.name}</outputDirectory>
                  <includes>
                     <include>*.jar</include>
                  </includes>
                  <excludes>
                     <exclude>*tests.jar</exclude>
                     <exclude>*sources.jar</exclude>
                  </excludes>
               </fileSet>
            </fileSets>
         </sources>

         <binaries>
            <outputDirectory>modules/demos/${module.basedir.name}</outputDirectory>
            <outputFileNameMapping>
               ${module.artifactId}.${module.extension}
            </outputFileNameMapping>
            <unpack>false</unpack>
         </binaries>
      </moduleSet>

      <!-- Demos only! -->
      <moduleSet>
         <includeSubModules>false</includeSubModules>
         <includes>
            <include>org.infinispan:infinispan-gui-demo</include>
            <include>org.infinispan:infinispan-ec2-demo</include>
            <include>org.infinispan:infinispan-distexec-demo</include>
            <include>org.infinispan:infinispan-directory-demo</include>
            <include>org.infinispan:infinispan-nearcache-demo</include>
            <include>org.infinispan:infinispan-lucene-demo</include>
         </includes>
         <sources>
            <includeModuleDirectory>false</includeModuleDirectory>

            <fileSets>
               <!-- Executable resources -->
               <fileSet>
                  <directory>src/main/release</directory>
                  <outputDirectory></outputDirectory>
                  <lineEnding>unix</lineEnding>
                  <includes>
                     <include>**/*.sh</include>
                     <include>**/*.py</include>
                     <include>**/*.rb</include>
                  </includes>
                  <fileMode>0755</fileMode>
               </fileSet>

               <fileSet>
                  <directory>src/main/release</directory>
                  <outputDirectory></outputDirectory>
                  <lineEnding>dos</lineEnding>
                  <includes>
                     <include>**/*.cmd</include>
                     <include>**/*.bat</include>
                  </includes>
                  <fileMode>0644</fileMode>
               </fileSet>

               <!-- Configuration resources -->
               <fileSet>
                  <directory>src/main/release</directory>
                  <outputDirectory></outputDirectory>
                  <lineEnding>unix</lineEnding>
                  <includes>
                     <include>**/*.properties</include>
                     <include>**/*.xml</include>
                     <include>**/*.xsd</include>
                     <include>**/*.html</include>
                     <include>**/*.js</include>
                     <include>**/*.css</include>
                  </includes>
               </fileSet>

               <!-- Binary resources -->
               <fileSet>
                  <directory>src/main/release</directory>
                  <outputDirectory></outputDirectory>
                  <lineEnding>keep</lineEnding>
                  <includes>
                     <include>**/*.gz</include>
                  </includes>
               </fileSet>

               <!-- Schema -->
               <fileSet>
                  <directory>target/classes</directory>
                  <outputDirectory>etc</outputDirectory>
                  <lineEnding>unix</lineEnding>
                  <includes>
                     <include>**/*.xsd</include>
                  </includes>
               </fileSet>

               <!-- EULAs and license files -->
               <fileSet>
                  <directory>src/main/release</directory>
                  <outputDirectory></outputDirectory>
                  <lineEnding>dos</lineEnding>
                  <includes>
                     <include>**/*.txt</include>
                  </includes>
               </fileSet>

               <!-- runtime-classpath.txt file -->
               <fileSet>
                  <directory>target</directory>
                  <outputDirectory>modules/demos/${module.basedir.name}</outputDirectory>
                  <lineEnding>keep</lineEnding>
                  <includes>
                     <include>runtime-classpath.txt</include>
                  </includes>
               </fileSet>
            </fileSets>

         </sources>

         <binaries>
            <outputDirectory>modules/demos/${module.basedir.name}</outputDirectory>
            <outputFileNameMapping>
               ${module.artifactId}.${module.extension}
            </outputFileNameMapping>
            <unpack>false</unpack>
         </binaries>
      </moduleSet>

      <!-- CDI -->
      <moduleSet>
         <includeSubModules>false</includeSubModules>
         <includes>
            <include>org.infinispan:infinispan-cdi</include>
         </includes>
         <sources>
            <includeModuleDirectory>false</includeModuleDirectory>

            <fileSets>
               <!-- runtime-classpath.txt file -->
               <fileSet>
                  <directory>target</directory>
                  <lineEnding>keep</lineEnding>
                  <outputDirectory>modules/cdi</outputDirectory>
                  <includes>
                     <include>runtime-classpath.txt</include>
                  </includes>
               </fileSet>
            </fileSets>
         </sources>

         <binaries>
            <outputDirectory>modules/cdi</outputDirectory>
            <outputFileNameMapping>
               ${module.artifactId}.${module.extension}
            </outputFileNameMapping>
            <unpack>false</unpack>
         </binaries>
      </moduleSet>

   </moduleSets>

   <fileSets>

      <!-- docs -->
      <fileSet>
         <directory>target/site/apidocs</directory>
         <outputDirectory>doc/apidocs</outputDirectory>
      </fileSet>

   </fileSets>

</assembly>
