name: Clients Build and Test

on:
  push:
    branches:
      - 14.0.x
  pull_request:
    branches:
      - 14.0.x

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Maven Install
        run: |
            # Ensure this plugin is built first to avoid warnings in the build
            ./mvnw install -B -Pdistribution
            # By using "dependency:resolve", it will download all dependencies used in later stages for running the tests
            ./mvnw install dependency:resolve -B -V -e -DskipTests -DexcludeGroupIds=org.infinispan -Dsilent=true

      - name: Maven Verify
        run: |
            CLIENTS=$(find client -maxdepth 2 -name pom.xml -exec dirname {} \; | paste -sd ',' -)
            ./mvnw verify -V -B -e -DrerunFailingTestsCount=2 \
            -Dmaven.test.failure.ignore=true -Dansi.strip=true \
            -pl core,$CLIENTS \
            -Dgithub.action=true

      - name: Publish Clients Test Report
        if: (success() || failure())
        # Waiting for https://github.com/ScaCap/action-surefire-report/pull/251
        uses: ScaCap/action-surefire-report@v1
        with:
            check_name: Clients Test Report Result
            ignore_flaky_tests: true
            report_paths: |
              **/*-reports*/**/TEST-*.xml
              !**/*FLAKY*.xml
