# This workflow builds and tests Infinispan client modules for the 14.0.x branch.
# It runs on pushes and pull requests targeting the 14.0.x branch.
#
# NOTE: This workflow replaces the CI pipelines used on the main branch.
# The 14.0.x branch is too old to be tested with the current CI tools and infrastructure
# used on main, so this simplified workflow provides basic build and test coverage.
name: Clients Build and Test

on:
  push:
    branches:
      - 14.0.x
  pull_request:
    branches:
      - 14.0.x

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v4

      # Set up Java 17 (Temurin distribution) required for building Infinispan
      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'

      # Build and install the project dependencies
      # This step runs in two phases:
      # 1. Build the distribution profile to ensure plugins are available
      # 2. Install all dependencies and resolve them for later test execution
      - name: Maven Install
        run: |
            # Ensure this plugin is built first to avoid warnings in the build
            ./mvnw install -B -Pdistribution
            # By using "dependency:resolve", it will download all dependencies used in later stages for running the tests
            ./mvnw install dependency:resolve -B -V -e -DskipTests -DexcludeGroupIds=org.infinispan -Dsilent=true

      # Run tests on core and all client modules
      # This step:
      # - Dynamically finds all client modules (max 2 levels deep in client/ directory)
      # - Runs verify phase with tests on core + discovered clients
      # - Reruns failing tests up to 2 times to handle flaky tests
      # - Continues even if tests fail (for reporting purposes)
      - name: Maven Verify
        run: |
            CLIENTS=$(find client -maxdepth 2 -name pom.xml -exec dirname {} \; | paste -sd ',' -)
            ./mvnw verify -V -B -e -DrerunFailingTestsCount=2 \
            -Dmaven.test.failure.ignore=true -Dansi.strip=true \
            -pl core,$CLIENTS \
            -Dgithub.action=true

      # Publish test results as a GitHub check
      # This runs regardless of whether tests pass or fail
      # Excludes any files marked as FLAKY from the report
      - name: Publish Clients Test Report
        if: (success() || failure())
        uses: ScaCap/action-surefire-report@v1.9.1
        with:
            check_name: Clients Test Report Result
            ignore_flaky_tests: true
            report_paths: |
              **/*-reports*/**/TEST-*.xml
              !**/*FLAKY*.xml
